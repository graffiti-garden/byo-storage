<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Graffiti Data Store</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>

    <body>
        <button
            id="toggleLogIn"
            onclick="ds.toggleLogIn().then(()=>setLogInButton())"
        ></button>

        <div id="stuff">
            Channel:
            <input id="channel" type="text" value="something" />
            <br />
            <button onclick="watch()">Watch Channel</button>
            <br />
            Data:
            <input id="data" type="text" />
            <br />
            <button onclick="postData()">Post Data to Channel</button>
            <ul id="posts"></ul>
        </div>

        <script type="module">
            import DataStore from "/dist/index.js";
            window.ds = new DataStore({ clientId: "h4bnq16igcef7tg" });

            window.setLogInButton = () => {
                const toggleLogInButton =
                    document.getElementById("toggleLogIn");
                const stuffEl = document.getElementById("stuff");
                if (ds.loggedIn) {
                    toggleLogInButton.innerText = "Log Out";
                    stuffEl.style.display = "block";
                } else {
                    toggleLogInButton.innerText = "Log In";
                    stuffEl.style.display = "none";
                }
            };
            setLogInButton();

            let controller;
            let watching;
            window.watch = async () => {
                const channel = document.getElementById("channel").value;

                // If we're already watching this channel, do nothing
                if (watching == channel) {
                    return;
                }

                // Stop the previous watch, if it exists
                if (controller) {
                    controller.abort();
                }
                controller = new AbortController();

                // Get the shared link
                const sharedLink = await ds.getSharedLink(channel);

                // Clear the list of posts
                const posts = document.getElementById("posts");
                posts.innerHTML = "";

                // Start the new watch
                watching = channel;
                for await (const post of ds.watch(
                    channel,
                    sharedLink,
                    controller.signal,
                )) {
                    const li = document.createElement("li");
                    li.innerText = new TextDecoder().decode(post);
                    posts.appendChild(li);
                }
            };

            window.postData = async () => {
                const channel = document.getElementById("channel").value;
                const dataEl = document.getElementById("data");
                const data = new TextEncoder().encode(dataEl.value);
                await ds.post(channel, data);
            };
        </script>
    </body>
</html>
