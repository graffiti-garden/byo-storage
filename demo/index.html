<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Graffiti Data Store</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>

    <body>
        <button id="toggleLogIn" onclick="byos.toggleLogIn()"></button>

        <div id="stuff">
            Channel:
            <input id="channel" type="text" value="something" />
            <br />
            <button onclick="watch()">Watch Channel</button>
            <br />
            Data:
            <input id="data" type="text" />
            <br />
            <button onclick="postData()">Post Data to Channel</button>
            <ul id="posts"></ul>
        </div>

        <script type="module">
            import BYOStorage from "/dist/index.js";
            // import BYOStorage from "https://cdn.jsdelivr.net/npm/@graffiti-garden/byo-storage";

            window.byos = new BYOStorage({
                authentication: {
                    clientId: "h4bnq16igcef7tg",
                },
                onLoginStateChange(loginState) {
                    const toggleLogInButton =
                        document.getElementById("toggleLogIn");
                    const stuffEl = document.getElementById("stuff");
                    if (loginState) {
                        toggleLogInButton.innerText = "Log Out";
                        stuffEl.style.display = "block";
                    } else {
                        toggleLogInButton.innerText = "Log In";
                        stuffEl.style.display = "none";
                    }
                },
            });

            let controller;
            let watching;
            window.watch = async () => {
                const channel = document.getElementById("channel").value;

                // If we're already watching this channel, do nothing
                if (watching == channel) {
                    return;
                }

                // Stop the previous watch, if it exists
                if (controller) {
                    controller.abort();
                }
                controller = new AbortController();

                // Get the shared link
                const sharedLink = await byos.getSharedLink(channel);

                // Clear the list of posts
                const posts = document.getElementById("posts");
                posts.innerHTML = "";

                // Start the new watch
                watching = channel;
                for await (const action of byos.watch(
                    channel,
                    sharedLink,
                    controller.signal,
                )) {
                    // Convert the UUID from Uint8Array to a string
                    const uuid = new TextDecoder().decode(action.uuid);

                    if (action.type === "post") {
                        // Check if the UUID already exists...
                        let li = document.getElementById(uuid);

                        // Otherwise create a new element
                        if (!li) {
                            li = document.createElement("li");
                            li.id = uuid;
                            posts.appendChild(li);
                        }

                        // Fill the text with the new text
                        const text = new TextDecoder().decode(action.data);

                        li.innerText = text;

                        const delButton = document.createElement("button");
                        delButton.innerText = "␡";
                        delButton.onclick = () =>
                            byos.remove(channel, action.uuid);
                        li.appendChild(delButton);

                        const editButton = document.createElement("button");
                        editButton.innerText = "‼";
                        editButton.onclick = () =>
                            byos.post(
                                channel,
                                new TextEncoder().encode(text + "!!"),
                                action.uuid,
                            );
                        li.appendChild(editButton);
                    } else if (action.type == "remove") {
                        const li = document.getElementById(uuid);
                        if (li) {
                            li.remove();
                        }
                    } else if (action.type == "backlog-complete") {
                        console.log("Backlog complete");
                    }
                }
            };

            window.postData = async () => {
                const channel = document.getElementById("channel").value;
                const dataEl = document.getElementById("data");
                const data = new TextEncoder().encode(dataEl.value);
                await byos.post(channel, data);
            };
        </script>
    </body>
</html>
